#
# Test Framework!
#

Test = Object.new(
  suites: []

  # All tests start with a `describe` block, which defines a test suite.
  # describe should be given a string `name` for the suite
  # and a block in `as` in which tests will be defined.
  describe: { |name, as|
    suite = Suite.new(name: name)
    as(suite.test)
    suites.push(suite)

    # TODO: The actual running of tests should happen in a different object
    # Need something here because we have nothing else at this time.
    self.runAll()
  },

  runAll: {
    runner = Runner

    suites.each({ |suite|
      runner.run(suite)
    })

    runner.outputResults()
  },
)

Suite = Object.new(
  tests: [],

  # Define an individual test.
  # If no block is given, this test is marked as "pending".
  test: { |name, is: null|
    tests.push(Unit.new(name: name, test: is))
  },

  run: { |runner|
    tests.each({ |test|
      test.run(runner)
    })
  }
)

Unit = Object.new(
  name: null,
  test: null,
)

Runner = Object.new(
  results: [],

  assertions: 0,

  successes: 0,

  failures: 0,

  assert: { |expr, message: null|
    assertions = assertions + 1

    expr.do(
      ifTrue: { success() },
      ifFalse: { failure(message) }
    )
  },

  success: {
    successes = successes + 1
    IO.print(".")
  },

  failure: { |message: null|
    failures = failures + 1
    IO.print("F")
  },

  run: { |suite|
    assertCB = self.assert
    suite.tests.each({ |test|
      test.test(assertCB)
    })
  },

  outputResults: {
    IO.puts("")
    IO.puts("Finished: " + assertions + " assertions, " + successes + " successful, " + failures + " failed")
    IO.puts("")
  }
)
